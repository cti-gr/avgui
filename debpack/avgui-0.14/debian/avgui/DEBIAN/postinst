#!/bin/bash
# see: dh_installdeb(1)

set -e

CREATE_TBL_MALWARE="CREATE TABLE tblMalware(
ID INTEGER PRIMARY KEY AUTOINCREMENT,
Name TEXT NOT NULL UNIQUE
)"

CREATE_TBL_VIRUSDBS="CREATE TABLE tblVirusDBs (
ID INTEGER PRIMARY KEY AUTOINCREMENT,
DBVersion TEXT NOT NULL,
DBrDate TEXT NOT NULL)"

CREATE_TABLE_SCANEVENT="CREATE TABLE tblScanEvent (
ID INTEGER PRIMARY KEY AUTOINCREMENT,
User TEXT NOT NULL,
NoOfInfections INTEGER NOT NULL,
NoOfHealings INTEGER NOT NULL,
DateTime TEXT NOT NULL,
VirusDBID INTEGER NOT NULL,
FOREIGN KEY(VirusDBID) REFERENCES tblVirusDBs(ID)
)"

CREATE_TBL_INF="CREATE TABLE tblInfections (
ID INTEGER PRIMARY KEY AUTOINCREMENT,
FilePath TEXT NOT NULL,
Inode INTEGER NOT NULL UNIQUE,
ScanEventID INTEGER NOT NULL,
MalwareID INTEGER NOT NULL,
FOREIGN KEY(ScanEventID) REFERENCES tblScanEvent(ID),
FOREIGN KEY(MalwareID) REFERENCES tblMalware(ID)
)"

USER_HOME=$(eval echo ~${SUDO_USER})

echo "USER HOME IS  "  ${USER_HOME}

# summary of how this script can be called:
# * <postinst> `configure' <most-recently-configured-version>
# * <old-postinst> `abort-upgrade' <new version>
# * <conflictor's-postinst> `abort-remove' `in-favour' <package>
# <new-version>
# * <postinst> `abort-remove'
# * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
# <failed-install-package> <version> `removing'
# <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in

  configure)
	mkdir -p "${USER_HOME}"/.avgui
	echo "Creating tables needed to keep avg history"
  	sqlite3 "${USER_HOME}"/.avgui/avghistory.sqlite "${CREATE_TBL_MALWARE}; ${CREATE_TBL_VIRUSDBS}; ${CREATE_TABLE_SCANEVENT}; ${CREATE_TBL_INF}"
	echo "Assigning avghistory.sqlite file to user " "${SUDO_USER}"
	chown -R "${SUDO_USER}":"${SUDO_USER}" "${USER_HOME}"/.avgui/
  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    	exit 0
  ;;

  *)
    	echo "postinst called with unknown argument \`$1'" >&2
    	exit 1
  ;;

esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0
